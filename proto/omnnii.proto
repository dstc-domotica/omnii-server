syntax = "proto3";
package omnii;

service OmniiService {
  // Enrollment - unauthenticated, only needs valid enrollment code
  rpc Enroll(EnrollRequest) returns (EnrollResponse);

  // Refresh short-lived access tokens
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);

  // All methods below require token authentication via metadata
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc ReportUpdates(UpdateReportRequest) returns (UpdateReportResponse);
  rpc ReportStats(StatsReportRequest) returns (StatsReportResponse);
  rpc ReportConnectivity(ConnectivityReportRequest)
      returns (ConnectivityReportResponse);

  // Trigger an update on the addon (server -> addon request)
  rpc TriggerUpdate(TriggerUpdateRequest) returns (TriggerUpdateResponse);
}

// Enrollment messages
message EnrollRequest {
  string code = 1; // The enrollment code from the UI
}
message EnrollResponse {
  bool success = 1;
  string error = 2;                  // Error message if success=false
  string instance_id = 3;            // e.g. "ha-a1b2"
  string access_token = 4;           // Short-lived JWT access token
  string refresh_token = 5;          // Long-lived refresh token
  int64 access_token_expires_at = 6; // Unix timestamp (seconds)
}

// Refresh token messages
message RefreshTokenRequest { string refresh_token = 1; }
message RefreshTokenResponse {
  bool success = 1;
  string error = 2;
  string access_token = 3;
  string refresh_token = 4;
  int64 access_token_expires_at = 5; // Unix timestamp (seconds)
}

// System information from Supervisor /info API
message SystemInfo {
  string supervisor = 1;
  string homeassistant = 2;
  string hassos = 3; // May be empty if not HA OS
  string docker = 4;
  string hostname = 5;
  string operating_system = 6;
  string machine = 7;
  string arch = 8;
  string channel = 9; // stable, beta, dev
  string state = 10;  // running, etc.
}

// Heartbeat messages - optional system info
message HeartbeatRequest {
  SystemInfo system_info = 1; // Optional - sent periodically
  int64 client_timestamp = 2; // Client-side timestamp for RTT calculation
}
message HeartbeatResponse {
  bool alive = 1;
  int64 time = 2;
  int64 latency_ms = 3; // Round-trip latency in milliseconds
}

// Update reporting messages
message ComponentUpdate {
  string component_type = 1; // "core", "os", "supervisor", "addon"
  string slug = 2;           // Addon slug (or empty)
  string name = 3;           // Addon name (or empty)
  string version = 4;
  string version_latest = 5;
  bool update_available = 6;
}

message UpdateReport {
  int64 generated_at = 1; // Unix timestamp (seconds)
  repeated ComponentUpdate components = 2;
}

message UpdateReportRequest { UpdateReport report = 1; }

message UpdateReportResponse {
  bool accepted = 1;
  string message = 2;
}

// Core stats reporting
message CoreStats {
  double cpu_percent = 1;
  int64 memory_usage = 2;
  int64 memory_limit = 3;
  double memory_percent = 4;
  int64 network_tx = 5;
  int64 network_rx = 6;
  int64 blk_read = 7;
  int64 blk_write = 8;
}

message StatsReport {
  int64 generated_at = 1; // Unix timestamp (seconds)
  CoreStats stats = 2;
}

message StatsReportRequest { StatsReport report = 1; }

message StatsReportResponse {
  bool accepted = 1;
  string message = 2;
}

// Connectivity reporting (internet reachability checks)
message ConnectivityCheck {
  string target = 1;    // e.g. "8.8.8.8"
  string status = 2;    // reachable, unreachable, timeout
  int64 latency_ms = 3; // 0 if unavailable
  string error = 4;     // Error message if failed
}

message ConnectivityReportRequest {
  int64 client_timestamp = 1; // Client-side timestamp (ms)
  string public_ip = 2;       // Public IP reported by the addon
  repeated ConnectivityCheck checks = 3;
}

message ConnectivityReportResponse {
  bool accepted = 1;
  string message = 2;
}

// Trigger update messages - server asks addon to perform an update
message TriggerUpdateRequest {
  string update_type = 1; // "core", "os", "supervisor", "addon"
  string addon_slug = 2;  // Only needed if update_type is "addon"
}
message TriggerUpdateResponse {
  bool success = 1;
  string error = 2;
  string message = 3; // Status message (e.g., "Update started")
}
